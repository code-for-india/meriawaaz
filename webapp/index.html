<!doctype html>
<html lang="en">
    <head>
        <title>Safe Route</title>

        <meta charset="utf-8" />




        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
        <meta http-equiv="content-language" content="en" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <link type="text/css" rel="stylesheet" href="css/jquery-mobile-1.0/jquery.mobile.css" />
        <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false&libraries=places"></script> 
        <script type="text/javascript" src="js/jquery-1.7.1/jquery.min.js"></script>
        <script type="text/javascript" src="js/jquery-mobile-1.0/jquery.mobile.min.js"></script>
        <script type="text/javascript" src="js/demo.js"></script>
        <script type="text/javascript" src="ui/jquery.ui.map.js"></script>
        <script src="./js/jquery.datetimepicker.js"></script>
        <script src="./js/date.js"></script>
        <script type="text/javascript">
            var mobileDemo = {'center': '57.7973333,12.0502107', 'zoom': 10};
            var currentPosition;
            //Fallback location if geo is disabled.
            var googleLocation = new google.maps.LatLng(37.421942, -122.08450);
            //Canvas for rendering Google Maps
            var repor_map;
            //Map to save the time stamps of various events
            var timeMap;
            //Map to save incidences corresponding to  various events
            var incidenceMap;
            //List of all the markers.
            var markers = [];
            //Count of incidences to report in single submit
            var markerCount;
            //Pieces forming the infobox's inner HTML
            var contentStringPart1 = '<div id="infobox-';
            //Preferable to add a global init method for fetching all the enums from the server.
            var contentStringPart2 = '">' +
                    '<div><label>Select DateTime: </label><input class="date-time-picker-class"/></div>' +
                    '<div><label>Select incidence:</label>' +
                    '<input type="checkbox" class="incidence-class" name="incidence" value="1"/><label>Whistling</label>' +
                    '<input type="checkbox" class="incidence-class" name="incidence" value="2"/><label>Eve teasing</label>' +
                    '<input type="checkbox" class="incidence-class" name="incidence" value="3"/><label>Chain snatching</label>' +
                    '<input type="checkbox" class="incidence-class" name="incidence" value="4"/><label>Molestation</label>' +
                    '<input type="checkbox" class="incidence-class" name="incidence" value="5"/><label>Rape</label>' +
                    '</div></div>';
            var autocomplete, geocoder;
           
            function initReport(lat, lng) {
                     markerCount = 0;
                timeMap = new Object();
                incidenceMap = new Object(); 
                currentPosition = new google.maps.LatLng(lat,lng);
                
                var myOptions = {
                    zoom: 17,
                    mapTypeId: google.maps.MapTypeId.ROADMAP,
                    center: currentPosition
                }
            //guard to from crashing safari browser.
            if(typeof repor_map == 'undefined') {                
                repor_map = new google.maps.Map(document.getElementById("report-map-canvas"), myOptions);
            } else {
                repor_map.setCenter(currentPosition);
            }
            
//                google.maps.event.trigger(repor_map, 'resize');
                 setTimeout(function() {
                        google.maps.event.trigger(repor_map,'resize');
                    }, 500);
               
                google.maps.event.addDomListener(window, 'load', reportInitialize);
                google.maps.event.addListener(repor_map, 'click', function(event) {
                    var marker = new google.maps.Marker({
                        map: repor_map,
                        draggable: true,
                        position: event.latLng,
                    });
                    initAndAddMarker(marker);
                });
                
                $("#submit-button").click(function() {
                    var pushJson = '';
                    for (var index in markers) {
                        var marker = markers[index];
                        var valIncidences = '';
                        markerId = marker.index;
                        if (markerId in incidenceMap) {
                            var incidences = incidenceMap[markerId];
                            for (incidence in incidences) {
                                valIncidences += incidence + ",";
                            }
                        }
                        var coordinates = marker.getPosition();
                        pushJson += "{"
                                + "incidence:{lat:" + coordinates.lat().toString() + ",lng:" + coordinates.lng().toString() + "},"
                                + "datetime:" + timeMap[markerId] + ","
                                + "incidences:" + valIncidences
                                + "},";
                    }
                    alert(pushJson);
                });
            }

            function initAndAddMarker(marker) {
                var markerId = markerCount;
                var infowindow = new google.maps.InfoWindow({
                    content: contentStringPart1 + markerId.toString() + contentStringPart2
                });
                google.maps.event.addListener(infowindow, 'closeclick', function() {
                    timeMap[markerId.toString()] = $("#infobox-" + markerId + " .date-time-picker-class").datetimepicker('getDateTime').val().toString();
                    var incidences = new Array();
                    var count = 0;
                    $("#infobox-" + markerId + " :checkbox:checked").each(function(i) {
                        incidences[count++] = $(this).val();
                    });
                    incidenceMap[markerId.toString()] = incidences;
                });
                google.maps.event.addListener(marker, 'dblclick', function() {
                    var newMarkers = {};
                    for (index in markers) {
                        if (markers[index].index != marker.index) {
                            newMarkers.push(markers[index]);
                        }
                    }
                    markers = newMarkers;
                    marker.setMap(null);
                });

                google.maps.event.addListener(marker, 'click', function(event) {
                    infowindow.open(repor_map, marker);
                    $(".date-time-picker-class").datetimepicker({mask: '9999/19/39 29:59', });
                    if (markerId in timeMap) {
                        $("#infobox-" + markerId + " .date-time-picker-class").datetimepicker({value: timeMap[markerId], mask: '9999/19/39 29:59', });
                    } else {
                        var currentDT = new Date().toString('yyyy/MM/dd HH:mm');
                        $("#infobox-" + markerId + " .date-time-picker-class").datetimepicker({value: currentDT, mask: '9999/19/39 29:59', });
                    }
                    if (markerId in incidenceMap) {
                        var incidences = incidenceMap[markerId];
                        $('input[type=checkbox]').each(function(i) {
                            if (incidences.indexOf($(this).val()) > -1) {
                                $(this).prop('checked', true);
                            }
                        });
                    }
                });

                marker.index = markerCount;
                markers.push(marker);
                markerCount++;
            }
            ;

            function reportInitialize() {
                
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                        var pos = new google.maps.LatLng(position.coords.latitude,
                                position.coords.longitude);
                        renderMap(pos);
                    }, function() {
                        renderMap(googleLocation);
                    });
                } else {
                    // Browser doesn't support Geolocation
                    renderMap(googleLocation);
                }
                initCanvas();
            }

            function renderMap(pos) {
                repor_map.setCenter(pos);
            }

            function initCanvas() {
                autocomplete = new google.maps.places.Autocomplete((document.getElementById('address-box')), {types: ['geocode']});
                google.maps.event.addListener(autocomplete, 'place_changed', function() {
                    dropPin();
                });
            }

            function geolocate() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                        var geolocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                        autocomplete.setBounds(new google.maps.LatLngBounds(geolocation, geolocation));
                    });
                }
                geocoder = new google.maps.Geocoder();
            }

            function dropPin() {
                var address = document.getElementById('address-box').value;
                geocoder.geocode({'address': address}, function(results, status) {
                    if (status == google.maps.GeocoderStatus.OK) {
                        repor_map.setCenter(results[0].geometry.location);
                        var marker = new google.maps.Marker({
                            map: repor_map,
                            draggable: true,
                            position: results[0].geometry.location
                        });
                        initAndAddMarker(marker);
                    } else {
                        alert('Geocode was not successful for the following reason: ' + status);
                    }
                    $('#address-box').val('');
                });
            }
            $('#report_page').live('pageinit', function() {
                demo.add('report_page', function() {
                    $('#report-map-canvas').gmap({'center': mobileDemo.center, 'zoom': mobileDemo.zoom, 'disableDefaultUI': true, 'callback': function() {
                         initReport();
                         $("#report-map-canvas").css("display","flex")
                        }});
                }).load('report_page');
            });
            /////////////////////////////////////above this report code

          
            ////////////////////////////////////////////////////////////

            $('#basic_map').live('pageinit', function() {
                demo.add('basic_map', function() {
                    $('#saferoute_map_canvas').gmap({'center': mobileDemo.center, 'zoom': mobileDemo.zoom, 'disableDefaultUI': true, 'callback': function() {
                          initSafeRoute();
                        }});
                }).load('basic_map');
            });
            
            $(document).live("pagebeforeshow", "#map_page", function() {
                
                navigator.geolocation.getCurrentPosition(locSuccess, locError);
                $("#saferoute_map_canvas").css({height: $("#basic_map").height() / 2.102});
                
                $("#report-map-canvas").css({height: $("#report_page").height() / 2.102});
                
            });

            $(document).on('click', '#submit', function(e) {
                e.preventDefault();
                calculateRoute();
            });

            var directionDisplay,
                    directionsService = new google.maps.DirectionsService(),
                    map;
            function initSafeRoute(lat, lng) {
                directionsDisplay = new google.maps.DirectionsRenderer();
                //var mapCenter = new google.maps.LatLng(59.3426606750, 18.0736160278);
                currentPosition = new google.maps.LatLng(lat, lng);
                var myOptions = {
                    zoom: 17,
                    mapTypeId: google.maps.MapTypeId.ROADMAP,
                    center: currentPosition
                }
                //guard to from crashing safari browser.
                if(typeof map == 'undefined') {
                  map = new google.maps.Map(document.getElementById("saferoute_map_canvas"), myOptions);
                } else {
                    map.setCenter(currentPosition);
                }
                 setTimeout(function() {
                        google.maps.event.trigger(map,'resize');
                    }, 500);
                directionsDisplay.setMap(map);
                directionsDisplay.setPanel(document.getElementById("directions"));
                var currentPositionMarker = new google.maps.Marker({
                    position: currentPosition,
                    map: map,
                    title: "Current position"
                });
                new google.maps.places.Autocomplete(document.getElementById('from'));

                new google.maps.places.Autocomplete(document.getElementById('to'));

                var infowindow = new google.maps.InfoWindow();
                google.maps.event.addListener(currentPositionMarker, 'click', function() {
                    infowindow.setContent("Current position: latitude: " + lat + " longitude: " + lon);
                    infowindow.open(map, currentPositionMarker);
                    alert(currentPositionMarker.getDuration().seconds);
                });

            }

            function locError(error) {
                $("#from").attr("placeHolder", "Enter current location"); 
                $("#saferoute_map_canvas").css({height: $("#basic_map").height() / 2.102});
                $("#report-map-canvas").css({height: $("#report_page").height() / 2.102});
                 initSafeRoute(position.coords.latitude, position.coords.longitude);
                 initReport(position.coords.latitude, position.coords.longitude);                 
            }

            function locSuccess(position) {
                $("#from").attr("placeHolder", "Found current location");
                initSafeRoute(position.coords.latitude, position.coords.longitude); 
                $("#saferoute_map_canvas").css({height: $("#basic_map").height() / 2.102});
                 $("#report-map-canvas").css({height: $("#report_page").height() / 2.102});
                initReport(position.coords.latitude, position.coords.longitude);
                 
            }
            function highLightTravelMode(travelMode) {

                $("#DRIVING").css("border-bottom", "");
                $("#WALKING").css("border-bottom", "");
                $("#TRANSIT").css("border-bottom", "");
                $("#BICYCLING").css("border-bottom", "");
                $(travelMode).css("border-bottom", "4px solid blue");

            }
            function calculateRoute(travelMode) {
                if (typeof travelMode == 'undefined') {
                    travelMode = "DRIVING";
                }
                highLightTravelMode("#" + travelMode);
                var targetDestination = $("#to").val();

                if (currentPosition == null || currentPosition == '' || $("#from").val() != '') {
                    currentPosition = $("#from").val();
                }
                if (currentPosition && currentPosition != '' && targetDestination && targetDestination != '') {
                    var request = {
                        origin: currentPosition,
                        destination: targetDestination,
                        travelMode: google.maps.DirectionsTravelMode[travelMode]
                    };

                    directionsService.route(request, function(response, status) {
                        if (status == google.maps.DirectionsStatus.OK) {
                            directionsDisplay.setPanel(document.getElementById("directions"));
                            directionsDisplay.setDirections(response);

                            //$("#results").show();
                        }
                        else {
                            $("#results").hide();
                        }
                    });
                }
                else {
                    $("#results").hide();
                }


            }

            var tog = false;
            function togglePlanPanel() {
                if (!tog) {
                    $("#planPanel").slideDown();
                    $("#showspace").slideDown();
//                    $("#from").slideUp();
//                    $("#to").slideUp();
//                    $("#submit").slideUp();
                } else {
                    $("#planPanel").slideUp();
                    $("#showspace").slideUp();
//                     $("#from").slideDown();
//                    $("#to").slideDown();
//                    $("#submit").slideDown();
                }
                tog = !tog;

            }



        </script>

    </head>
    <body>


        <div id="home" data-role="page" data-theme="d">

            <div data-role="content">					
                <img id="topImg" src="images/ic_launcher.png" width="100" height="100" style="display: block; margin: 0 auto">
                <ul data-role="listview" data-inset="true"  data-dividertheme="d"> 
                    <li><a href="#basic_map">Take a safe route</a></li> 
                    
                    <li><a href="#report_page">Report unsafe area</a></li> 
                </ul>
            </div>

        </div>

        <div id="basic_map" data-role="page">
            <div data-role="header">
                <div>
                    <!--<a href='javascript:history.back();' data-rel="back">Back</a>-->
                    <img src="images/ic_launcher.png" onclick="javascript:history.back();">
                    <img src="images/plus.png" style="float:right" onclick="window.location='#report_page'">
                </div>

            </div>
            <div data-role="content"  data-theme="d" id="mapScreenArea">
                <div id="planPanel" style="display:none">
                    <table style="width:100%">
                        <tr>
                            <td style="text-align: center" id="DRIVING">
                                <img src="images/car.jpg"  onclick="calculateRoute('DRIVING');"/>
                            </td>
                            <td style="text-align: center" id="TRANSIT">
                                <img src="images/bus.jpg"  onclick="calculateRoute('TRANSIT');"/>
                            </td>
                            <td style="text-align: center;" id="WALKING">
                                <img src="images/man.jpg"  onclick="calculateRoute('WALKING');"/>
                            </td>
                            <td style="text-align: center" id="BICYCLING">
                                <img src="images/cycle.jpg"  onclick="calculateRoute('BICYCLING');"/>
                            </td>                         

                        </tr>
                    </table>

                    <br/>

                    <table style="width:100%" >
                        <tr>
                            <td style="width:50%">
                                Record you trip safety
                            </td>
                            <td style="width:20%">
                                <select  data-role="slider" id="toggle1" >
                                    <option value="off">Off</option>
                                    <option value="on">On</option>
                                </select> 
                            </td>
                        </tr>
                    </table>
                    <br/>

                    <table style="width:100%" >
                        <tr>
                            <td style="width:50%">
                                Show unsafe areas
                            </td>
                            <td style="width:20%">
                                <select  data-role="slider" id="toggle2" >
                                    <option value="off">Off</option>
                                    <option value="on">On</option>
                                </select> 
                            </td>
                        </tr>
                    </table>
                    <table style="width:100%;padding-top: 10px" >
                        <tr>
                            <td style="width:50%">
                                Route type
                            </td>
                            <td style="width:20%">
                                <select  data-role="slider" id="toggle3" data-theme="c" data-track-theme="b">
                                    <option value="time">Time</option>
                                    <option value="safe">Safe</option>
                                </select> 
                            </td>
                        </tr>
                    </table>
                </div>
                <div id="showspace" style="display:none"><br/><br/></div>
                <div >
                    <ul data-role="listview" >
                        <image src="images/handle.png" id="handle" onclick="togglePlanPanel();" width="100%" height="13px"/>
                        <li >
                            <input placeholder="Current location" name="from" id="from" />
                        </li>
                        <li >
                            <input placeholder="Enter destination" name="to" id="to" />
                        </li>

                        <a data-icon="search" style="height: 30px" data-role="button" href="#" id="submit">Get directions</a>

                    </ul>

                </div>
                <br/>

                <div class="ui-bar-c ui-corner-all ui-shadow">
                    <div   id="saferoute_map_canvas"  ></div >
                </div>
                <div id="results">
                    <div id="directions"></div>
                </div>

            </div>

        </div>

        <div id="report_page" data-role="page">
            <div data-role="header">
                <div>
                 <!--<a href='javascript:history.back();' data-rel="back">Back</a>-->
                 <img src="images/ic_launcher.png" onclick="javascript:history.back();">
                </div>
                <!--<img src="images/ic_launcher.png" data-rel="back">--> 
            </div>
            <div data-role="content" data-theme="d">
                <div id="address-canvas" align="center" style="margin-top:1px">
                    <label>Click on the map or enter street address: </label>
                    <input placeholder="Enter the address" style="width:90%;" onFocus="geolocate()" type="text" id="address-box"></input>
                </div>
                <div id="report-map-canvas" style="display: flex;margin-top:10px;" ></div>
                <div id="report-button-canvas" style="margin:0 auto; width:50%; margin-top:10px"><button id="submit-button">Submit</button></div>
            </div>
        </div>



    </body>
</html>

